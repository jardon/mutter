From: Daniel van Vugt <daniel.van.vugt@canonical.com>
Date: Fri, 14 Apr 2023 18:10:36 +0800
Subject: backends/x11: Trap errors from XIChangeProperty

And report them as warnings instead of crashing.

https://launchpad.net/bugs/2014986

https://gitlab.gnome.org/GNOME/mutter/-/merge_requests/2960
---
 src/backends/x11/meta-input-settings-x11.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/src/backends/x11/meta-input-settings-x11.c b/src/backends/x11/meta-input-settings-x11.c
index 4022351..9a0b37e 100644
--- a/src/backends/x11/meta-input-settings-x11.c
+++ b/src/backends/x11/meta-input-settings-x11.c
@@ -170,6 +170,7 @@ change_property (MetaInputSettings  *settings,
   int device_id;
   Atom property_atom;
   guchar *data_ret;
+  int err;
 
   property_atom = XInternAtom (xdisplay, property, True);
   if (!property_atom)
@@ -181,8 +182,19 @@ change_property (MetaInputSettings  *settings,
   if (!data_ret)
     return;
 
+  meta_clutter_x11_trap_x_errors ();
   XIChangeProperty (xdisplay, device_id, property_atom, type,
                     format, XIPropModeReplace, data, nitems);
+  XSync (xdisplay, False);
+  err = meta_clutter_x11_untrap_x_errors ();
+  if (err)
+    {
+      g_warning ("XIChangeProperty failed on device %d property \"%s\" with X error %d",
+                 device_id,
+                 property,
+                 err);
+    }
+
   meta_XFree (data_ret);
 }
 
