From: Iain Lane <iainl@gnome.org>
Date: Wed, 14 Aug 2019 16:08:48 +0100
Subject: tests: Tag unstable tests as flaky

Then test runners can run these ones non-fatally.

This is Debian-only: for upstream these tests should be fixed.

Forwarded: not-needed
---
 src/tests/clutter/conform/meson.build |  6 +++++-
 src/tests/meson.build                 | 23 ++++++++++++++++++++---
 2 files changed, 25 insertions(+), 4 deletions(-)

diff --git a/src/tests/clutter/conform/meson.build b/src/tests/clutter/conform/meson.build
index b10299e..b2e4ef2 100644
--- a/src/tests/clutter/conform/meson.build
+++ b/src/tests/clutter/conform/meson.build
@@ -74,8 +74,12 @@ foreach test : clutter_conform_tests
     install: false,
   )
 
+  suites = ['clutter', 'clutter/conform']
+  if test in ['timeline', 'timeline-interpolate']
+    suites += ['flaky']
+  endif
   test(test, test_executable,
-    suite: ['clutter', 'clutter/conform'],
+    suite: suites,
     env: test_env,
     is_parallel: false,
   )
diff --git a/src/tests/meson.build b/src/tests/meson.build
index 3768b83..02a24da 100644
--- a/src/tests/meson.build
+++ b/src/tests/meson.build
@@ -250,6 +250,7 @@ test_cases += [
   },
   {
     'name': 'stage-views',
+    'flaky': true,
     'suite': 'compositor',
     'sources': [ 'stage-view-tests.c', ],
   },
@@ -500,7 +501,8 @@ if have_native_tests
     )
 
     test(test_case['name'], test_executable,
-      suite: ['core', 'mutter/' + test_case['suite']],
+      suite: ['core', 'mutter/' + test_case['suite']]
+        + (test_case.get('flaky', false) ? ['flaky'] : []),
       env: test_env,
       is_parallel: false,
       timeout: 60,
@@ -509,7 +511,6 @@ if have_native_tests
 endif
 
 stacking_tests = [
-  'basic-x11',
   'basic-wayland',
   'client-side-decorated',
   'closed-transient',
@@ -521,7 +522,6 @@ stacking_tests = [
   'closed-transient-no-input-parents',
   'closed-transient-no-input-parents-queued-default-focus-destroyed',
   'closed-transient-only-take-focus-parents',
-  'minimized',
   'mixed-windows',
   'set-parent',
   'override-redirect',
@@ -546,6 +546,23 @@ stacking_tests = [
   'workspace-only-on-primary-focus',
 ]
 
+flaky_stacking_tests = [
+  'basic-x11',
+  'minimized',
+]
+
+foreach flaky_stacking_test: flaky_stacking_tests
+  test(flaky_stacking_test, test_runner,
+    suite: ['core', 'mutter/stacking', 'flaky'],
+    env: test_env,
+    args: [
+      files(join_paths('stacking', flaky_stacking_test + '.metatest')),
+    ],
+    is_parallel: false,
+    timeout: 60,
+  )
+endforeach
+
 foreach stacking_test: stacking_tests
   test(stacking_test, test_runner,
     suite: ['core', 'mutter/stacking'],
